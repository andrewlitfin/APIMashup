<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
 	<title>Marvelpedia</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="hash.js"></script>
    <script>
        "use strict";
                
        var MARVEL_URL = "http://gateway.marvel.com/v1/public/callback=jsonLoaded&"
        var MARVEL_API_PUBLIC_KEY = "e2abba687aff830cb2b9347173cf493d";
        var MARVEL_API_PRIVATE_KEY = "d505fc5779c7ac23f6b298fa0d6224c4d5e38fe1";
        
        window.onload = init;
        
        function init(){
            $("#searchButton").click(function(){
                var charToSearch = $("#characterName").val();
                console.log(charToSearch);
                // build up our Marvel URL string
                var marvelUrl = MARVEL_URL 
                marvelUrl += "characters?name=";
                marvelUrl += charToSearch;
                marvelUrl += "&limit=99&apikey=";
                marvelUrl += MARVEL_API_PUBLIC_KEY;
                
                
                //first select a random year
                var year = 2010;
                //then a month
                var month = 4;
                var monthStr = month<10?"0"+month:month;
                var beginDateStr = year + "-" + monthStr + "-01";
                var eom = 24;
                var endDateStr = year + "-" + monthStr + "-" + eom;
                
                marvelUrl = "http://gateway.marvel.com/v1/public/comics?limit=100&format=comic&formatType=comic&dateRange="+beginDateStr+"%2C"+endDateStr+"&apikey="+MARVEL_API_PUBLIC_KEY;

                var ts = new Date().getTime();
                var hash = calcMD5(ts + MARVEL_API_PRIVATE_KEY + MARVEL_API_PUBLIC_KEY);
                marvelUrl += "&ts="+ts+"&hash="+hash;
                                
                // call the web service, and download the file
                console.log(marvelUrl);
                $("#content").fadeOut(250);
                $.ajax({
                    dataType: "jsonp",
                    url: marvelUrl,
                    data: null,
                    success: jsonLoaded
                });
            });
        }
        function jsonLoaded(obj){
            console.log("obj = " +obj);
            console.log("obj stringified = " + JSON.stringify(obj));            
     
            // if there's an error, print a message and return
            if (obj.code != 200){
                var status = obj.status;
                document.querySelector("#content").innerHTML = "<h3><b>Error!</b></h3>" + "<p><i>" + status + "</i><p>";
                $("#content").fadeIn(500);
                return; // Bail out
            }
            // if there are no results, print a message and return
            if(obj.data.count == 0){
                var status = "No results found";
                document.querySelector("#content").innerHTML = "<p><i>" + status + "</i><p>" + "<p><i>";
                $("#content").fadeIn(500);
                return; // Bail out
            }
        }
    </script>
</head>
<body>
    <input type="text" id="characterName" value="Deadpool">
    <button id="searchButton">Search</button>
    <div id="content">
    </div>
</body>
</html>
